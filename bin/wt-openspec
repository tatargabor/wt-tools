#!/usr/bin/env bash
# wt-openspec - CLI wrapper for OpenSpec operations
# Provides init, update, and fast filesystem-based status for GUI consumption.

set -euo pipefail

# Global --project override (set by main before dispatch)
PROJECT=""

usage() {
    cat <<EOF
Usage: wt-openspec <command> [options]

CLI wrapper for OpenSpec project management.

Commands:
  status [--json]     Show OpenSpec status (filesystem-based, fast)
  init                Initialize OpenSpec in the project (openspec init --tools claude)
  update              Update OpenSpec skills (openspec update)

Global options:
  --project NAME      Override project name (default: auto-detect from git root)

EOF
}

# Resolve the main repo path for the current project
resolve_main_repo() {
    local toplevel
    if [[ -n "$PROJECT" ]]; then
        # If --project given, we still need the repo path — try cwd
        toplevel=$(git rev-parse --show-toplevel 2>/dev/null) || true
    else
        toplevel=$(git rev-parse --show-toplevel 2>/dev/null) || true
    fi

    if [[ -z "$toplevel" ]]; then
        echo ""
        return 1
    fi

    # Check if this is a worktree — get the main repo
    local common_dir
    common_dir=$(git -C "$toplevel" rev-parse --git-common-dir 2>/dev/null) || true
    if [[ -n "$common_dir" && "$common_dir" != ".git" && "$common_dir" != "$toplevel/.git" ]]; then
        # This is a worktree, resolve to main repo
        local resolved
        resolved=$(cd "$toplevel" && cd "$common_dir" && cd .. && pwd)
        echo "$resolved"
    else
        echo "$toplevel"
    fi
}

# Status: filesystem-based, no subprocess to openspec CLI
cmd_status() {
    local json_mode=false

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --json) json_mode=true; shift ;;
            *) shift ;;
        esac
    done

    local main_repo
    main_repo=$(resolve_main_repo) || true

    if [[ -z "$main_repo" ]]; then
        if [[ "$json_mode" == "true" ]]; then
            echo '{"installed": false, "version": null, "changes_active": 0, "skills_present": false}'
        else
            echo "Not in a git repository"
        fi
        return 0
    fi

    # Check openspec/config.yaml
    local installed=false
    if [[ -f "$main_repo/openspec/config.yaml" ]]; then
        installed=true
    fi

    # Count active change dirs (excluding archive)
    local changes_active=0
    if [[ -d "$main_repo/openspec/changes" ]]; then
        for dir in "$main_repo/openspec/changes"/*/; do
            [[ -d "$dir" ]] || continue
            local dirname
            dirname=$(basename "$dir")
            [[ "$dirname" == "archive" ]] && continue
            changes_active=$((changes_active + 1))
        done
    fi

    # Check skills
    local skills_present=false
    if [[ -d "$main_repo/.claude/skills" ]]; then
        for skill_dir in "$main_repo/.claude/skills"/openspec-*/; do
            if [[ -d "$skill_dir" ]]; then
                skills_present=true
                break
            fi
        done
    fi

    # Check CLI availability (no subprocess — just path check)
    local cli_available=false
    if command -v openspec >/dev/null 2>&1; then
        cli_available=true
    fi

    # Get version only for human-readable output (slow: ~200ms Node.js startup)
    local version="null"

    if [[ "$json_mode" == "true" ]]; then
        # Fast path: no version subprocess
        echo "{\"installed\": $installed, \"version\": null, \"changes_active\": $changes_active, \"skills_present\": $skills_present, \"cli_available\": $cli_available}"
    else
        # Human-readable: get version (slow but only for interactive use)
        if [[ "$cli_available" == "true" ]]; then
            local ver_output
            ver_output=$(openspec --version 2>/dev/null) || true
            if [[ -n "$ver_output" ]]; then
                version=$(echo "$ver_output" | grep -oE '[0-9]+\.[0-9]+\.[0-9]+' | head -1)
                [[ -z "$version" ]] && version="null"
            fi
        fi

        echo "OpenSpec Status:"
        echo "  Repo: $main_repo"
        if [[ "$installed" == "true" ]]; then
            echo "  Installed: yes"
            echo "  Active changes: $changes_active"
            echo "  Skills present: $skills_present"
        else
            echo "  Installed: no"
        fi
        if [[ "$version" != "null" ]]; then
            echo "  CLI version: $version"
        else
            echo "  CLI: not found"
        fi
    fi
}

# Init: run openspec init --tools claude
cmd_init() {
    # Check openspec CLI exists
    if ! command -v openspec >/dev/null 2>&1; then
        echo "Error: openspec CLI not found. Install with: npm install -g @fission-ai/openspec" >&2
        return 1
    fi

    local main_repo
    main_repo=$(resolve_main_repo) || true

    if [[ -z "$main_repo" ]]; then
        echo "Error: not in a git repository" >&2
        return 1
    fi

    # Check not already initialized
    if [[ -f "$main_repo/openspec/config.yaml" ]]; then
        echo "OpenSpec already initialized in $main_repo"
        return 0
    fi

    echo "Initializing OpenSpec in $main_repo..."
    (cd "$main_repo" && openspec init --tools claude)
}

# Update: run openspec update
cmd_update() {
    # Check openspec CLI exists
    if ! command -v openspec >/dev/null 2>&1; then
        echo "Error: openspec CLI not found. Install with: npm install -g @fission-ai/openspec" >&2
        return 1
    fi

    local main_repo
    main_repo=$(resolve_main_repo) || true

    if [[ -z "$main_repo" ]]; then
        echo "Error: not in a git repository" >&2
        return 1
    fi

    # Check already initialized
    if [[ ! -f "$main_repo/openspec/config.yaml" ]]; then
        echo "Error: OpenSpec not initialized in $main_repo" >&2
        return 1
    fi

    echo "Updating OpenSpec skills in $main_repo..."
    (cd "$main_repo" && openspec update --force)
}

# Main dispatch
main() {
    # Parse global options before command
    while [[ $# -gt 0 ]]; do
        case "$1" in
            --project)
                PROJECT="$2"
                shift 2
                ;;
            *)
                break
                ;;
        esac
    done

    if [[ $# -eq 0 ]]; then
        usage
        exit 0
    fi

    local command="$1"
    shift

    case "$command" in
        status)   cmd_status "$@" ;;
        init)     cmd_init "$@" ;;
        update)   cmd_update "$@" ;;
        -h|--help|help) usage ;;
        *)
            echo "Error: Unknown command '$command'" >&2
            usage >&2
            exit 1
            ;;
    esac
}

main "$@"
