#!/usr/bin/env bash
# wt-version - Display wt-tools version information

set -euo pipefail

# Follow symlink to find source directory
get_source_dir() {
    local script_path="${BASH_SOURCE[0]}"

    # Follow symlinks
    while [[ -L "$script_path" ]]; do
        local link_target
        link_target=$(readlink "$script_path")
        if [[ "$link_target" == /* ]]; then
            script_path="$link_target"
        else
            script_path="$(dirname "$script_path")/$link_target"
        fi
    done

    # Get the directory containing the script
    cd "$(dirname "$script_path")" && pwd
}

usage() {
    cat <<EOF
Usage: wt-version [options]

Display wt-tools version information.

Options:
  --json    Output as JSON
  -h, --help    Show this help
EOF
}

main() {
    local json_output=false

    while [[ $# -gt 0 ]]; do
        case "$1" in
            --json)
                json_output=true
                shift
                ;;
            -h|--help)
                usage
                exit 0
                ;;
            *)
                echo "Unknown option: $1" >&2
                usage
                exit 1
                ;;
        esac
    done

    local source_dir
    source_dir=$(get_source_dir)

    # Go up one level from bin/ to repo root
    local repo_dir
    repo_dir=$(dirname "$source_dir")

    # Check for git repo (can be .git directory or .git file for worktrees)
    if [[ ! -e "$repo_dir/.git" ]]; then
        echo "Error: Source directory is not a git repository: $repo_dir" >&2
        exit 1
    fi

    # Get git info
    local branch commit date
    branch=$(git -C "$repo_dir" rev-parse --abbrev-ref HEAD 2>/dev/null || echo "unknown")
    commit=$(git -C "$repo_dir" rev-parse --short=7 HEAD 2>/dev/null || echo "unknown")
    date=$(git -C "$repo_dir" log -1 --format=%cs 2>/dev/null || echo "unknown")

    if $json_output; then
        cat <<EOF
{
  "branch": "$branch",
  "commit": "$commit",
  "date": "$date",
  "source_dir": "$repo_dir"
}
EOF
    else
        echo "wt-tools ($branch @ $commit, $date)"
        echo "Source: $repo_dir"
    fi
}

main "$@"
