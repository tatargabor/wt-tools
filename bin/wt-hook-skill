#!/usr/bin/env bash
# wt-hook-skill - Claude Code UserPromptSubmit hook for skill tracking
#
# Called by Claude Code on every user prompt submission.
# Extracts skill name from prompt text (e.g. "/wt:status ..." → "wt:status")
# and registers it via wt-skill-start.
#
# Designed to be referenced by name in .claude/settings.json:
#   "UserPromptSubmit": [{"matcher": "", "hooks": [{"type": "command", "command": "wt-hook-skill"}]}]
# The script is on PATH via install.sh symlink.

# Read hook input from stdin
INPUT=$(cat)

# Extract prompt text from JSON: {"prompt": "/wt:status ...", ...}
PROMPT=$(echo "$INPUT" | python3 -c "import sys,json; print(json.load(sys.stdin).get('prompt',''))" 2>/dev/null)

if [[ -z "$PROMPT" ]]; then
    exit 0
fi

# Extract skill name from /skill-name pattern at start of prompt
# Matches: /wt:list, /wt:status, /jira:show, etc.
SKILL_NAME=$(echo "$PROMPT" | python3 -c "
import sys,re
prompt = sys.stdin.read().strip()
m = re.match(r'^/(\S+)', prompt)
print(m.group(1) if m else '')
" 2>/dev/null)

if [[ -n "$SKILL_NAME" ]]; then
    # Skill invocation — register as fresh
    wt-skill-start "$SKILL_NAME" 2>/dev/null || true
else
    # Non-skill prompt — mark existing skill as "last" (no longer fresh)
    # Find our claude ancestor PID to locate the right .skill file
    CLAUDE_PID=$(python3 -c "
import os, subprocess
pids = {}
for line in subprocess.check_output(['ps', '-e', '-o', 'pid=,comm=']).decode().splitlines():
    parts = line.split()
    if len(parts) >= 2 and parts[1] == 'claude':
        pids[int(parts[0])] = True
pid = os.getpid()
while pid > 1:
    if pid in pids:
        print(pid)
        break
    try:
        pid = int(subprocess.check_output(['ps', '-o', 'ppid=', '-p', str(pid)]).decode().strip())
    except:
        break
" 2>/dev/null)

    if [[ -n "$CLAUDE_PID" ]]; then
        SKILL_FILE=".wt-tools/agents/${CLAUDE_PID}.skill"
        if [[ -f "$SKILL_FILE" ]]; then
            CONTENT=$(cat "$SKILL_FILE" 2>/dev/null)
            # Only update if currently fresh
            if [[ "$CONTENT" == *"|fresh" ]]; then
                echo "${CONTENT%|fresh}|last" > "$SKILL_FILE"
            fi
        fi
    fi
fi

exit 0
