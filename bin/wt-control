#!/usr/bin/env bash
# wt-control - Launch the Worktree Control Center GUI

# Source user profile for desktop entry launches (Alt+F2)
# This ensures PATH includes conda, pyenv, etc.
if [[ -z "${WT_CONTROL_PROFILE_SOURCED:-}" ]]; then
    export WT_CONTROL_PROFILE_SOURCED=1
    for profile in "$HOME/.profile" "$HOME/.bash_profile" "$HOME/.bashrc"; do
        if [[ -f "$profile" ]]; then
            source "$profile" 2>/dev/null || true
            break
        fi
    done
fi

# Follow symlinks to find the real script location
get_real_dir() {
    local script="${BASH_SOURCE[0]}"
    while [[ -L "$script" ]]; do
        local link=$(readlink "$script")
        if [[ "$link" == /* ]]; then
            script="$link"
        else
            script="$(dirname "$script")/$link"
        fi
    done
    cd "$(dirname "$script")" && pwd
}

SCRIPT_DIR="$(get_real_dir)"
PROJECT_ROOT="$(dirname "$SCRIPT_DIR")"
GUI_DIR="$PROJECT_ROOT/gui"
LOG_FILE="$HOME/.cache/wt-control.log"

# Find python3 - check common locations if not in PATH
find_python() {
    if command -v python3 &>/dev/null; then
        command -v python3
        return 0
    fi
    # Check common locations
    for p in /usr/bin/python3 "$HOME/.local/bin/python3" "$HOME/miniconda3/bin/python3" "$HOME/anaconda3/bin/python3"; do
        if [[ -x "$p" ]]; then
            echo "$p"
            return 0
        fi
    done
    return 1
}

PYTHON=$(find_python)
if [[ -z "$PYTHON" ]]; then
    echo "Error: python3 not found" | tee -a "$LOG_FILE" >&2
    exit 1
fi

# Check if PySide6 is installed
if ! "$PYTHON" -c "import PySide6" 2>/dev/null; then
    echo "PySide6 not found. Installing dependencies..." | tee -a "$LOG_FILE"
    pip3 install -r "$GUI_DIR/requirements.txt" 2>&1 | tee -a "$LOG_FILE"
fi

# Set PYTHONPATH to ensure gui package can be imported
export PYTHONPATH="$PROJECT_ROOT:${PYTHONPATH:-}"

# Set QT_PLUGIN_PATH to avoid conda/system Qt conflicts
if [[ -z "${QT_PLUGIN_PATH:-}" ]]; then
    pyside_qt_plugins=$("$PYTHON" -c "import PySide6; print(PySide6.__path__[0] + '/Qt/plugins')" 2>/dev/null)
    if [[ -d "$pyside_qt_plugins" ]]; then
        export QT_PLUGIN_PATH="$pyside_qt_plugins"
    fi
fi

# Create cache dir for log
mkdir -p "$(dirname "$LOG_FILE")"

# Launch GUI (log errors for debugging desktop entry issues)
exec "$PYTHON" "$GUI_DIR/main.py" "$@" 2>> "$LOG_FILE"
